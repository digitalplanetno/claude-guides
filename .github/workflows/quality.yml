name: Quality Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

  markdownlint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: '**/*.md'
          config: '.markdownlint.json'

  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required sections in audit files
        run: |
          echo "Checking audit files for required sections..."
          ERRORS=0

          for f in templates/**/SECURITY_AUDIT.md templates/**/PERFORMANCE_AUDIT.md templates/**/CODE_REVIEW.md templates/**/DEPLOY_CHECKLIST.md; do
            [ -f "$f" ] || continue
            if ! grep -q "QUICK CHECK" "$f"; then
              echo "❌ Missing QUICK CHECK: $f"
              ERRORS=$((ERRORS + 1))
            fi
            if ! grep -q "САМОПРОВЕРКА\|SELF-CHECK" "$f"; then
              echo "❌ Missing SELF-CHECK section: $f"
              ERRORS=$((ERRORS + 1))
            fi
            if ! grep -q "ФОРМАТ ОТЧЁТА\|OUTPUT FORMAT" "$f"; then
              echo "❌ Missing REPORT FORMAT: $f"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "Found $ERRORS errors"
            exit 1
          fi
          echo "✅ All audit templates valid"

  test-init-script:
    name: Test Init Script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test Laravel detection
        run: |
          cd /tmp
          touch artisan
          bash $GITHUB_WORKSPACE/scripts/init-local.sh
          test -f .claude/prompts/SECURITY_AUDIT.md || exit 1
          echo "✅ Laravel init works"

      - name: Test Next.js detection
        run: |
          cd /tmp
          rm -rf .claude CLAUDE.md artisan
          touch next.config.js
          bash $GITHUB_WORKSPACE/scripts/init-local.sh
          test -f .claude/prompts/SECURITY_AUDIT.md || exit 1
          echo "✅ Next.js init works"
